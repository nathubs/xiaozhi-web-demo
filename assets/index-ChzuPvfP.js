(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))o(s);new MutationObserver(s=>{for(const a of s)if(a.type==="childList")for(const c of a.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&o(c)}).observe(document,{childList:!0,subtree:!0});function n(s){const a={};return s.integrity&&(a.integrity=s.integrity),s.referrerPolicy&&(a.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?a.credentials="include":s.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function o(s){if(s.ep)return;s.ep=!0;const a=n(s);fetch(s.href,a)}})();const T="modulepreload",_=function(t){return"/xiaozhi-web-demo/"+t},v={},w=function(e,n,o){let s=Promise.resolve();if(n&&n.length>0){let c=function(l){return Promise.all(l.map(m=>Promise.resolve(m).then(E=>({status:"fulfilled",value:E}),E=>({status:"rejected",reason:E}))))};document.getElementsByTagName("link");const r=document.querySelector("meta[property=csp-nonce]"),p=r?.nonce||r?.getAttribute("nonce");s=c(n.map(l=>{if(l=_(l),l in v)return;v[l]=!0;const m=l.endsWith(".css"),E=m?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${l}"]${E}`))return;const u=document.createElement("link");if(u.rel=m?"stylesheet":T,m||(u.as="script"),u.crossOrigin="",u.href=l,p&&u.setAttribute("nonce",p),document.head.appendChild(u),m)return new Promise((b,I)=>{u.addEventListener("load",b),u.addEventListener("error",()=>I(new Error(`Unable to preload CSS for ${l}`)))})}))}function a(c){const r=new Event("vite:preloadError",{cancelable:!0});if(r.payload=c,window.dispatchEvent(r),!r.defaultPrevented)throw c}return s.then(c=>{for(const r of c||[])r.status==="rejected"&&a(r.reason);return e().catch(a)})},M=1,k=24e3,C=60,se=24e3,O=!1,B="你好，小明",P="tts-start",U="tts-stop",L="received-radio",oe="detect-wake-up",R="send-text",N="received-text",V="received-emotion";class D{constructor(e){this.context=e}canHandle(e,n){return n?.data instanceof ArrayBuffer}handle(e,n){this.context.emit(L,n?.data)}}class W{constructor(e){this.context=e}canHandle(e){return e?.type==="llm"&&e?.emotion!==""}handle(e){this.context.emit(V,{emotionText:e.emotion,emotion:e.text})}}const A=[{name:"playMusic",description:"播放音乐，可随机或指定歌曲",inputSchema:{type:"object",properties:{song:{type:"string",description:"歌曲名（可选，留空为随机）"}},required:[]}},{name:"pauseMusic",description:"暂停音乐播放",inputSchema:{type:"object",properties:{},required:[]}},{name:"takePhoto",description:"你的眼睛，用于感知周围环境和拍照并识别画面内容",inputSchema:{type:"object",properties:{query:{type:"string",description:"识别画面内容的关键字"}},required:[]}},{name:"openCamera",description:"打开摄像头",inputSchema:{type:"object",properties:{},required:[]}},{name:"closeCamera",description:"关闭摄像头",inputSchema:{type:"object",properties:{},required:[]}},{name:"setVolume",description:"设置音量，范围0~100",inputSchema:{type:"object",properties:{volume:{type:"integer",description:"音量百分比（0~100）"}},required:["volume"]}},{name:"increaseVolume",description:"调大音量，每次增加10%",inputSchema:{type:"object",properties:{},required:[]}},{name:"decreaseVolume",description:"调小音量，每次减少10%",inputSchema:{type:"object",properties:{},required:[]}}],d={get value(){return typeof window<"u"?document.getElementById("music-audio"):null}};async function $(t){let e="http://192.168.50.188:8080/api/v1/music/info";t&&(e+=`?song=${encodeURIComponent(t)}`);const o=await(await fetch(e)).json();let s=o.audio_url;if(s&&!/^https?:\/\//.test(s)&&(s=`http://192.168.50.188:8080/api/v1/music${s}`),s&&s.includes("/get_file?")){const a=new URL(s);let c=a.searchParams.get("path"),r=a.searchParams.get("name");console.log("获取音乐文件 path:",c,"name:",r),c&&(c=encodeURIComponent(c.replace(/\\/g,"\\").replace(/\//g,"\\"))),r&&(r=encodeURIComponent(r));const p=s.split("?")[0],l=[];c&&l.push(`path=${c}`),r&&l.push(`name=${r}`),s=`${p}?${l.join("&")}`}if(!d.value){console.error("audio element not found in DOM");return}return d.value.removeEventListener("ended",()=>{}),d.value.addEventListener("ended",()=>{}),d.value.src="",d.value.load(),d.value.src=s,console.log("准备播放音频:",s),d.value.play().catch(a=>{console.error("音频播放失败:",s),console.error(a)}),o.name||t||"未知歌曲"}function j(){d.value&&d.value.pause()}async function H(t){return new Promise(async(e,n)=>{try{if(!i||!f){n("请先打开摄像头");return}const o=document.createElement("canvas");o.width=i.videoWidth||320,o.height=i.videoHeight||240;const s=o.getContext("2d");if(!s){n("无法获取 canvas 上下文");return}s.drawImage(i,0,0,o.width,o.height),o.toBlob(async a=>{if(!a){n("拍照失败，无法生成图片");return}const c=new FormData;c.append("image",a,"station.jpg"),t?c.append("message",t):c.append("message","照片中有什么");try{const r=await fetch("http://localhost:8080/api/v1/vision",{method:"POST",body:c,headers:{accept:"application/json"}});if(!r.ok){const l=await r.text();n(`接口请求失败: ${r.status} ${l}`);return}const p=await r.json();e(JSON.stringify(p))}catch(r){n(`接口请求异常: ${r instanceof Error?r.message:r}`)}},"image/jpeg")}catch(o){n(`拍照异常: ${o instanceof Error?o.message:o}`)}})}let f=null,i=null;function q(){return new Promise(async(t,e)=>{try{i||(i=document.createElement("video"),i.id="camera-video",i.autoplay=!0,i.playsInline=!0,i.style.position="fixed",i.style.right="20px",i.style.bottom="20px",i.style.width="320px",i.style.height="240px",i.style.zIndex="9999",i.style.background="#000",document.body.appendChild(i)),f=await navigator.mediaDevices.getUserMedia({video:!0}),i.srcObject=f,i.play(),t("摄像头已打开")}catch(n){e("无法打开摄像头: "+(n instanceof Error?n.message:n))}})}function K(){f&&(f.getTracks().forEach(t=>t.stop()),f=null),i&&(i.srcObject=null,i.parentNode&&i.parentNode.removeChild(i),i=null)}function g(t){d.value&&(d.value.volume=t/100)}function z(){if(d.value){const t=d.value.volume*100;g(Math.min(t+10,100))}}function F(){if(d.value){const t=d.value.volume*100;g(Math.max(t-10,0))}}const J={playMusic:async t=>$(t.arguments?.song).then(e=>({isError:!1,text:`正在播放歌曲：${e}`})),pauseMusic:async()=>(j(),{isError:!1,text:"音乐暂停成功"}),takePhoto:async t=>({isError:!1,text:`${await H(t.arguments?.query)}`}),openCamera:async()=>({isError:!1,text:`打开摄像头成功，照片地址：${await q()}`}),closeCamera:async()=>(K(),{isError:!1,text:"关闭摄像头成功"}),setVolume:async t=>{let e={isError:!0,text:"设置音量失败"};const{volume:n}=t.arguments;return n>=0&&n<=100&&(g(n),e.isError=!1,e.text="设置音量已调到"+n+"%"),e},increaseVolume:async()=>(z(),{isError:!1,text:"音量已调大"}),decreaseVolume:async()=>(F(),{isError:!1,text:"音量已调小"})};class X{constructor(e){this.context=e}canHandle(e){return e?.type==="mcp"}async handle(e){if(e?.payload?.method==="initialize")this.sendMcpMessage({jsonrpc:"2.0",id:e?.payload?.id,result:{success:!0}});else if(e?.payload?.method==="notifications/initialized")console.log("MCP 客户端已初始化完成");else if(e?.payload?.method==="tools/list")this.sendMcpMessage({jsonrpc:"2.0",id:e?.payload?.id,result:{tools:A}});else if(e?.payload?.method==="tools/call"&&e?.payload?.params){const n=J[e?.payload?.params.name];if(!n)this.sendMcpMessage({jsonrpc:"2.0",id:e?.payload?.id,result:{content:[{type:"text",text:"工具不存在，调用失败"}],isError:!0}});else{const o=await n(e?.payload?.params);this.sendMcpMessage({jsonrpc:"2.0",id:e?.payload?.id,result:{content:[{type:"text",text:o.text}],isError:o.isError}})}}}sendMcpMessage(e){this.context.sendMessage({type:"mcp",payload:e})}}class G{constructor(e){this.context=e}canHandle(e){return e?.type==="stt"&&e?.text}handle(e){e.text.includes(B)&&O||this.context.emit(R,e.text)}}class Q{constructor(e){this.context=e}canHandle(e){return e?.type==="tts"}handle(e,n,o){e.state==="sentence_start"&&e.text&&this.context.emit(N,e.text),e.state==="start"&&this.context.emit(P,n?.data),e.state==="stop"&&(this.context.emit(U,n?.data),o&&o.listenMode&&this.context.sendMessage({type:"listen",state:"start",mode:o.listenMode}))}}class h{constructor(){this.listeners={},this.listenMode="auto",this.handlers=[],this.registerHandlers(),this.connect()}static getInstance(){return h.instance||(h.instance=new h),h.instance}registerHandlers(){this.handlers=[new Q(this),new G(this),new W(this),new D(this),new X(this)]}connect(){this.authToken=localStorage.getItem("AUTH_TOKEN")||"Bearer test-token",this.deviceId=localStorage.getItem("DEVICE_ID")||"cc:ba:97:04:d2:f4",this.clientID=localStorage.getItem("CLIENT_ID")||"test-client-id",this.websocketUrl=localStorage.getItem("WEBSOCKET_URL")||"wss://ovurqhixraxb.sealosgzg.site/ws";const e=`${this.websocketUrl}?auth=${encodeURIComponent(this.authToken)}&device-id=${encodeURIComponent(this.deviceId)}&client-id=web-client`;this.ws=new WebSocket(e),this.ws.binaryType="arraybuffer",this.ws.onopen=this.handleOpen.bind(this),this.ws.onmessage=this.handleMessage.bind(this),this.ws.onclose=this.handleClose.bind(this),this.ws.onerror=this.handleError.bind(this)}reconnect(){this.ws&&this.ws.readyState!==WebSocket.CLOSED&&this.ws.close(),this.connect()}sendMessage(e){if(this.ws.readyState===WebSocket.OPEN){if(e instanceof Uint8Array){this.ws.send(e);return}console.log("Sending text content ============>:",JSON.stringify(e)),this.ws.send(JSON.stringify(e))}}handleOpen(){console.log("WebSocket opened"),this.sendMessage({type:"hello",transport:"websocket",version:1,features:{mcp:!0},response_mode:this.listenMode,audio_params:{format:"opus",sample_rate:k,channels:M,frame_duration:C}}),this.sendMessage({type:"listen",state:"detect",text:"你好"})}handleMessage(e){try{const n=typeof e.data=="string"?JSON.parse(e.data):null;n&&console.log("Received <===========:",n);for(const o of this.handlers)o.canHandle(n,e)&&o.handle(n,e,{listenMode:this.listenMode})}catch(n){console.error(n)}}handleClose(e){console.log("WebSocket closed",e.code,e.reason)}handleError(e){console.error("WebSocket error",e)}addListener(e,n){this.listeners[e]=n}removeListener(e){delete this.listeners[e]}emit(e,n){this.listeners[e]&&this.listeners[e](n)}}const Y=setTimeout(()=>{console.log("libopus load timeout, try to use libopus manually"),w(()=>import("./index-qvR1lxU3.js"),[])},100);libopus.onload=()=>{clearTimeout(Y),console.log("libopus loaded"),w(()=>import("./index-qvR1lxU3.js"),[])};const y=document.getElementById("settings-modal"),Z=document.getElementById("settings-btn"),ee=document.querySelector(".close"),te=document.getElementById("save-settings"),ne=document.getElementById("cancel-settings"),x="wss://ovurqhixraxb.sealosgzg.site/ws";window.onload=()=>{const t=localStorage.getItem("WEBSOCKET_URL");t?document.getElementById("websocket-url").value=t:document.getElementById("websocket-url").value=x};Z.onclick=()=>{const t=localStorage.getItem("WEBSOCKET_URL")||x;document.getElementById("current-websocket-url").textContent=t,document.getElementById("websocket-url").value="",y.style.display="block"};ee.onclick=()=>{y.style.display="none"};ne.onclick=()=>{y.style.display="none"};window.onclick=t=>{t.target==y&&(y.style.display="none")};te.onclick=()=>{const t=document.getElementById("websocket-url").value.trim();t?(localStorage.setItem("WEBSOCKET_URL",t),alert("WebSocket服务器地址已保存"),y.style.display="none"):alert("请输入WebSocket服务器地址")};const S=h.getInstance();document.getElementById("wake").onclick=()=>{S.reconnect()};document.getElementById("chat-send").onclick=()=>{const t=document.getElementById("chat-input"),e=t.value.trim();e&&(S.sendMessage({type:"listen",text:e,state:"detect"}),t.value="")};document.getElementById("chat-input").addEventListener("keydown",t=>{t.key==="Enter"&&document.getElementById("chat-send").click()});export{se as B,M as C,L as E,C as F,k as S,h as W,R as a,N as b,oe as c,B as d};
